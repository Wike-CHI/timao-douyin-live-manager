<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¯ä»˜å®¡æ ¸çŠ¶æ€æœºå¯è§†åŒ–æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .state-machine {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .state {
      flex: 1;
      padding: 20px;
      margin: 0 10px;
      border-radius: 8px;
      text-align: center;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    
    .state.unpaid { background: #e9ecef; color: #6c757d; }
    .state.pending { background: #f0e7ff; color: #764ba2; }
    .state.approved { background: #d4edda; color: #155724; }
    .state.rejected { background: #f8d7da; color: #721c24; }
    
    .state.active {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      transform: scale(1.05);
    }
    
    .state-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .state-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 5px;
    }
    
    .state-desc {
      font-size: 12px;
      opacity: 0.8;
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    button {
      padding: 12px 20px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-warning {
      background: #ffc107;
      color: #333;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .progress-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      display: none;
    }
    
    .progress-section.active {
      display: block;
    }
    
    .progress-bar {
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    
    .stat {
      text-align: center;
      padding: 10px;
      background: white;
      border-radius: 8px;
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
    }
    
    .log {
      background: #2d3748;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 12px;
      height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    
    .log-entry {
      margin-bottom: 8px;
      border-left: 3px solid #667eea;
      padding-left: 10px;
    }
    
    .log-time {
      color: #a0aec0;
      margin-right: 10px;
    }
    
    .log-info { border-color: #4299e1; }
    .log-success { border-color: #48bb78; }
    .log-warning { border-color: #ed8936; }
    .log-error { border-color: #f56565; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª æ”¯ä»˜å®¡æ ¸çŠ¶æ€æœºå¯è§†åŒ–æµ‹è¯•</h1>
    <p class="subtitle">éªŒè¯å®Œæ•´çš„çŠ¶æ€æµè½¬ï¼šUNPAID â†’ PENDING â†’ APPROVED/REJECTED</p>
    
    <!-- çŠ¶æ€æœºå¯è§†åŒ– -->
    <div class="state-machine">
      <div class="state unpaid active" id="state-unpaid">
        <div class="state-icon">ğŸ“„</div>
        <div class="state-title">UNPAID</div>
        <div class="state-desc">ç­‰å¾…æäº¤</div>
      </div>
      <div class="state pending" id="state-pending">
        <div class="state-icon">â³</div>
        <div class="state-title">PENDING</div>
        <div class="state-desc">å®¡æ ¸ä¸­</div>
      </div>
      <div class="state approved" id="state-approved">
        <div class="state-icon">âœ…</div>
        <div class="state-title">APPROVED</div>
        <div class="state-desc">å®¡æ ¸é€šè¿‡</div>
      </div>
      <div class="state rejected" id="state-rejected">
        <div class="state-icon">âŒ</div>
        <div class="state-title">REJECTED</div>
        <div class="state-desc">å®¡æ ¸æœªé€šè¿‡</div>
      </div>
    </div>
    
    <!-- è½®è¯¢è¿›åº¦ -->
    <div class="progress-section" id="progress-section">
      <h3>è½®è¯¢è¿›åº¦</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill">0%</div>
      </div>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">è½®è¯¢æ¬¡æ•°</div>
          <div class="stat-value" id="stat-attempts">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">å·²ç­‰å¾…ï¼ˆç§’ï¼‰</div>
          <div class="stat-value" id="stat-elapsed">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">è¿›åº¦</div>
          <div class="stat-value" id="stat-progress">0%</div>
        </div>
      </div>
    </div>
    
    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="controls">
      <button class="btn-primary" onclick="submitPayment()">1ï¸âƒ£ æäº¤æ”¯ä»˜å‡­è¯</button>
      <button class="btn-success" onclick="approvePayment()" id="btn-approve">2ï¸âƒ£ åå°æ‰¹å‡†å®¡æ ¸</button>
      <button class="btn-danger" onclick="rejectPayment()" id="btn-reject">3ï¸âƒ£ åå°æ‹’ç»å®¡æ ¸</button>
      <button class="btn-warning" onclick="cancelPolling()" id="btn-cancel" disabled>4ï¸âƒ£ ç”¨æˆ·å–æ¶ˆè½®è¯¢</button>
      <button class="btn-secondary" onclick="resetTest()">ğŸ”„ é‡ç½®æµ‹è¯•</button>
      <button class="btn-secondary" onclick="runAutoTest()">ğŸ¤– è‡ªåŠ¨æµ‹è¯•</button>
    </div>
    
    <!-- æ—¥å¿— -->
    <h3>æ“ä½œæ—¥å¿—</h3>
    <div class="log" id="log"></div>
  </div>
  
  <script>
    // çŠ¶æ€æœºé…ç½®
    const POLL_INTERVAL = 1000; // 1ç§’ï¼ˆæµ‹è¯•ç”¨ï¼Œå®é™…åº”ä¸º3ç§’ï¼‰
    const MAX_ATTEMPTS = 30;
    const TIMEOUT = 30000; // 30ç§’ï¼ˆæµ‹è¯•ç”¨ï¼Œå®é™…åº”ä¸º5åˆ†é’Ÿï¼‰
    
    // å…¨å±€å˜é‡
    let currentState = 'UNPAID';
    let backendStatus = 'pending'; // æ¨¡æ‹Ÿåç«¯å®¡æ ¸çŠ¶æ€
    let polling = null;
    let attempts = 0;
    let startTime = 0;
    let testResults = [];
    
    // å·¥å…·å‡½æ•°
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function setState(newState) {
      // ç§»é™¤æ‰€æœ‰ active ç±»
      document.querySelectorAll('.state').forEach(el => el.classList.remove('active'));
      
      // æ·»åŠ æ–°çŠ¶æ€çš„ active ç±»
      const stateEl = document.getElementById(`state-${newState.toLowerCase()}`);
      if (stateEl) {
        stateEl.classList.add('active');
      }
      
      currentState = newState;
      updateUI();
    }
    
    function updateUI() {
      const progressSection = document.getElementById('progress-section');
      const btnCancel = document.getElementById('btn-cancel');
      const btnApprove = document.getElementById('btn-approve');
      const btnReject = document.getElementById('btn-reject');
      
      if (currentState === 'PENDING') {
        progressSection.classList.add('active');
        btnCancel.disabled = false;
        btnApprove.disabled = false;
        btnReject.disabled = false;
      } else {
        progressSection.classList.remove('active');
        btnCancel.disabled = true;
        btnApprove.disabled = true;
        btnReject.disabled = true;
      }
    }
    
    function updateProgress() {
      if (currentState !== 'PENDING') return;
      
      const elapsed = Date.now() - startTime;
      const timeProgress = Math.min((elapsed / TIMEOUT) * 100, 100);
      const attemptProgress = Math.min((attempts / MAX_ATTEMPTS) * 100, 100);
      const progress = Math.max(timeProgress, attemptProgress);
      
      document.getElementById('stat-attempts').textContent = attempts;
      document.getElementById('stat-elapsed').textContent = Math.floor(elapsed / 1000);
      document.getElementById('stat-progress').textContent = Math.round(progress) + '%';
      document.getElementById('progress-fill').style.width = progress + '%';
      document.getElementById('progress-fill').textContent = Math.round(progress) + '%';
    }
    
    // çŠ¶æ€æœºæ“ä½œ
    function submitPayment() {
      if (currentState !== 'UNPAID' && currentState !== 'REJECTED') {
        log('âš ï¸ åªèƒ½åœ¨ UNPAID æˆ– REJECTED çŠ¶æ€ä¸‹æäº¤', 'warning');
        return;
      }
      
      setState('PENDING');
      backendStatus = 'pending';
      attempts = 0;
      startTime = Date.now();
      log('ğŸ“¤ æäº¤æ”¯ä»˜å‡­è¯æˆåŠŸï¼Œå¼€å§‹è½®è¯¢å®¡æ ¸çŠ¶æ€', 'success');
      startPolling();
    }
    
    function startPolling() {
      log('ğŸ”„ å¯åŠ¨è½®è¯¢...', 'info');
      
      if (polling) {
        clearInterval(polling);
      }
      
      polling = setInterval(async () => {
        attempts += 1;
        log(`ğŸ” æŸ¥è¯¢å®¡æ ¸çŠ¶æ€ï¼ˆç¬¬ ${attempts} æ¬¡ï¼‰`, 'info');
        updateProgress();
        
        // æ£€æŸ¥è¶…æ—¶
        const elapsed = Date.now() - startTime;
        if (elapsed >= TIMEOUT) {
          stopPolling();
          log(`â±ï¸ è½®è¯¢è¶…æ—¶ï¼ˆå·²è½®è¯¢ ${attempts} æ¬¡ï¼Œè€—æ—¶ ${Math.floor(elapsed / 1000)} ç§’ï¼‰`, 'warning');
          addTestResult('è¶…æ—¶å¤„ç†', true, `æ­£ç¡®åœæ­¢è½®è¯¢å¹¶æç¤ºç”¨æˆ·`);
          return;
        }
        
        // æ£€æŸ¥æœ€å¤§æ¬¡æ•°
        if (attempts >= MAX_ATTEMPTS) {
          stopPolling();
          log(`â±ï¸ å·²è¾¾æœ€å¤§è½®è¯¢æ¬¡æ•°ï¼ˆ${attempts} æ¬¡ï¼‰`, 'warning');
          addTestResult('æœ€å¤§æ¬¡æ•°é™åˆ¶', true, `æ­£ç¡®åœæ­¢è½®è¯¢`);
          return;
        }
        
        // æ¨¡æ‹ŸæŸ¥è¯¢åç«¯
        if (backendStatus === 'approved') {
          stopPolling();
          setState('APPROVED');
          log('âœ… å®¡æ ¸é€šè¿‡ï¼', 'success');
          addTestResult('å®¡æ ¸é€šè¿‡æµç¨‹', true, `è½®è¯¢ ${attempts} æ¬¡åæ­£ç¡®æ£€æµ‹åˆ° APPROVED`);
        } else if (backendStatus === 'rejected') {
          stopPolling();
          setState('REJECTED');
          log('âŒ å®¡æ ¸æœªé€šè¿‡', 'error');
          addTestResult('å®¡æ ¸æ‹’ç»æµç¨‹', true, `è½®è¯¢ ${attempts} æ¬¡åæ­£ç¡®æ£€æµ‹åˆ° REJECTED`);
        } else {
          log(`â³ ä»åœ¨å®¡æ ¸ä¸­...`, 'info');
        }
      }, POLL_INTERVAL);
    }
    
    function stopPolling() {
      if (polling) {
        clearInterval(polling);
        polling = null;
        log('â¹ï¸ åœæ­¢è½®è¯¢', 'info');
      }
    }
    
    function approvePayment() {
      if (currentState !== 'PENDING') {
        log('âš ï¸ åªèƒ½åœ¨ PENDING çŠ¶æ€ä¸‹æ‰¹å‡†', 'warning');
        return;
      }
      backendStatus = 'approved';
      log('ğŸ¯ [åå°æ“ä½œ] å®¡æ ¸çŠ¶æ€è®¾ä¸º APPROVED', 'success');
    }
    
    function rejectPayment() {
      if (currentState !== 'PENDING') {
        log('âš ï¸ åªèƒ½åœ¨ PENDING çŠ¶æ€ä¸‹æ‹’ç»', 'warning');
        return;
      }
      backendStatus = 'rejected';
      log('ğŸ¯ [åå°æ“ä½œ] å®¡æ ¸çŠ¶æ€è®¾ä¸º REJECTED', 'error');
    }
    
    function cancelPolling() {
      if (currentState !== 'PENDING') {
        log('âš ï¸ åªèƒ½åœ¨ PENDING çŠ¶æ€ä¸‹å–æ¶ˆ', 'warning');
        return;
      }
      
      stopPolling();
      setState('UNPAID');
      attempts = 0;
      log('ğŸš« ç”¨æˆ·å–æ¶ˆè½®è¯¢ï¼Œè¿”å› UNPAID çŠ¶æ€', 'warning');
      addTestResult('ç”¨æˆ·å–æ¶ˆ', true, 'æ­£ç¡®åœæ­¢è½®è¯¢å¹¶é‡ç½®çŠ¶æ€');
    }
    
    function resetTest() {
      stopPolling();
      setState('UNPAID');
      backendStatus = 'pending';
      attempts = 0;
      testResults = [];
      document.getElementById('log').innerHTML = '';
      log('ğŸ”„ æµ‹è¯•å·²é‡ç½®', 'info');
    }
    
    // æµ‹è¯•ç»“æœè®°å½•
    function addTestResult(testName, passed, details) {
      testResults.push({ testName, passed, details });
      const icon = passed ? 'âœ…' : 'âŒ';
      const type = passed ? 'success' : 'error';
      log(`${icon} æµ‹è¯•: ${testName} - ${details}`, type);
    }
    
    // è‡ªåŠ¨æµ‹è¯•
    async function runAutoTest() {
      log('ğŸ¤– å¼€å§‹è‡ªåŠ¨æµ‹è¯•...', 'info');
      resetTest();
      
      await sleep(1000);
      
      // æµ‹è¯•1ï¼šå®¡æ ¸é€šè¿‡æµç¨‹
      log('=== æµ‹è¯•1ï¼šå®¡æ ¸é€šè¿‡æµç¨‹ ===', 'info');
      submitPayment();
      await sleep(3000);
      approvePayment();
      await sleep(3000);
      
      if (currentState === 'APPROVED') {
        addTestResult('å®¡æ ¸é€šè¿‡æµç¨‹', true, 'çŠ¶æ€æ­£ç¡®è½¬æ¢åˆ° APPROVED');
      } else {
        addTestResult('å®¡æ ¸é€šè¿‡æµç¨‹', false, `çŠ¶æ€é”™è¯¯: ${currentState}`);
      }
      
      await sleep(2000);
      
      // æµ‹è¯•2ï¼šå®¡æ ¸æ‹’ç»æµç¨‹
      log('=== æµ‹è¯•2ï¼šå®¡æ ¸æ‹’ç»æµç¨‹ ===', 'info');
      resetTest();
      await sleep(1000);
      submitPayment();
      await sleep(3000);
      rejectPayment();
      await sleep(3000);
      
      if (currentState === 'REJECTED') {
        addTestResult('å®¡æ ¸æ‹’ç»æµç¨‹', true, 'çŠ¶æ€æ­£ç¡®è½¬æ¢åˆ° REJECTED');
      } else {
        addTestResult('å®¡æ ¸æ‹’ç»æµç¨‹', false, `çŠ¶æ€é”™è¯¯: ${currentState}`);
      }
      
      await sleep(2000);
      
      // æµ‹è¯•3ï¼šç”¨æˆ·å–æ¶ˆ
      log('=== æµ‹è¯•3ï¼šç”¨æˆ·å–æ¶ˆ ===', 'info');
      resetTest();
      await sleep(1000);
      submitPayment();
      await sleep(2000);
      cancelPolling();
      
      if (currentState === 'UNPAID') {
        addTestResult('ç”¨æˆ·å–æ¶ˆ', true, 'çŠ¶æ€æ­£ç¡®è¿”å› UNPAID');
      } else {
        addTestResult('ç”¨æˆ·å–æ¶ˆ', false, `çŠ¶æ€é”™è¯¯: ${currentState}`);
      }
      
      // è¾“å‡ºç»“æœ
      log('=== è‡ªåŠ¨æµ‹è¯•å®Œæˆ ===', 'success');
      const passed = testResults.filter(r => r.passed).length;
      const failed = testResults.filter(r => !r.passed).length;
      log(`æ€»è®¡: ${testResults.length} ä¸ªæµ‹è¯•ï¼Œé€šè¿‡: ${passed} ä¸ªï¼Œå¤±è´¥: ${failed} ä¸ª`, 
        failed === 0 ? 'success' : 'error');
    }
    
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // åˆå§‹åŒ–
    log('âœ¨ æ”¯ä»˜å®¡æ ¸çŠ¶æ€æœºæµ‹è¯•å·¥å…·å·²å°±ç»ª', 'success');
    log('ğŸ’¡ æç¤ºï¼šç‚¹å‡»æŒ‰é’®æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œå’Œåå°å®¡æ ¸', 'info');
    updateUI();
  </script>
</body>
</html>

