# 语音转写敏感度问题分析与优化建议

## 问题描述
用户反馈语音转写"有时候很灵敏有时候识别不到"，存在敏感度不一致的问题。

## 问题根因分析

通过对代码的深入分析，发现语音转写敏感度不一致主要由以下几个层面的参数配置影响：

### 1. LiveAudioStreamService 的 VAD (语音活动检测) 参数

**关键参数：**
- `vad_min_rms`: RMS阈值，决定音量多大才被认为是语音
- `vad_min_speech_sec`: 最小语音持续时间
- `vad_min_silence_sec`: 最小静音持续时间
- `vad_hangover_sec`: 语音结束后的挂起时间

**当前配置问题：**
```python
# 当前默认配置（可能过于保守）
self.vad_min_rms: float = 0.015         # RMS阈值
self.vad_min_speech_sec: float = 0.35   # 最小语音时间
self.vad_min_silence_sec: float = 0.60  # 最小静音时间
```

### 2. 音频门控算法 (audio_gate.py)

**影响因素：**
- RMS能量阈值过高，导致轻声说话无法通过
- 人声频带占比要求过严格
- 频谱特征判断过于保守

### 3. SenseVoice 置信度过滤

**关键参数：**
```python
min_confidence: float = 0.5  # 最小置信度阈值
```

**问题：**
- 置信度阈值0.5可能过高，导致一些有效语音被过滤
- 没有根据环境噪音动态调整置信度要求

### 4. 自动增益控制 (AGC) 配置

**当前配置：**
```python
self.agc_target_rms = 0.08    # 目标RMS
self.agc_max_gain = 6.0       # 最大增益
self.agc_smooth = 0.15        # 平滑系数
```

### 5. 背景音乐检测的干扰

**问题：**
- 背景音乐检测可能误判人声为音乐
- 音乐检测激活时会大幅提高VAD阈值

## 优化建议

### 方案一：快速修复（推荐）

通过环境变量调整关键参数：

```bash
# 降低VAD阈值，提高敏感度
export LIVE_VAD_MIN_RMS=0.012

# 减少最小语音时间，更快响应
export LIVE_VAD_MIN_SPEECH_SEC=0.25

# 减少最小静音时间，提高响应速度
export LIVE_VAD_MIN_SILENCE_SEC=0.45

# 启用快速档位
export LIVE_AUDIO_PROFILE=fast

# 提高AGC目标音量
export LIVE_AUDIO_AGC_TARGET=0.1

# 如果背景音乐干扰严重，可以暂时关闭音乐检测
export LIVE_VAD_MUSIC_DETECT=0
```

### 方案二：代码级优化

#### 1. 优化VAD参数
```python
# 在 LiveAudioStreamService.__init__ 中调整默认值
self.vad_min_rms: float = 0.012         # 降低RMS阈值
self.vad_min_speech_sec: float = 0.25   # 减少最小语音时间
self.vad_min_silence_sec: float = 0.45  # 减少最小静音时间
self.vad_hangover_sec: float = 0.5      # 增加挂起时间
```

#### 2. 调整置信度阈值
```python
# 在 ASTConfig 中降低默认置信度要求
min_confidence: float = 0.3  # 从0.5降低到0.3
```

#### 3. 优化音频门控算法
```python
# 在 audio_gate.py 的 is_speech_like 函数中
# 降低RMS阈值
if rms < 0.008:  # 从更高的值降低到0.008
    return False

# 放宽人声频带要求
human_voice_ratio = (mid_energy + high_energy) / total_energy
if human_voice_ratio < 0.25:  # 从更高的值降低到0.25
    return False
```

#### 4. 实现自适应阈值
```python
class AdaptiveVAD:
    def __init__(self):
        self.base_rms = 0.012
        self.noise_level = 0.0
        self.adaptation_rate = 0.1
    
    def update_noise_level(self, audio_chunk):
        # 估算背景噪音水平
        chunk_rms = np.sqrt(np.mean(audio_chunk ** 2))
        self.noise_level = (1 - self.adaptation_rate) * self.noise_level + \
                          self.adaptation_rate * chunk_rms
    
    def get_adaptive_threshold(self):
        # 根据噪音水平动态调整阈值
        return max(self.base_rms, self.noise_level * 2.0)
```

### 方案三：分场景优化

#### 1. 安静环境配置
```python
# 高敏感度配置
vad_min_rms = 0.008
vad_min_speech_sec = 0.2
min_confidence = 0.25
```

#### 2. 嘈杂环境配置
```python
# 抗噪配置
vad_min_rms = 0.018
vad_min_speech_sec = 0.4
min_confidence = 0.4
music_detection_enabled = True
```

#### 3. 直播环境配置
```python
# 平衡配置
vad_min_rms = 0.012
vad_min_speech_sec = 0.3
min_confidence = 0.35
agc_enabled = True
```

## 实施步骤

### 第一步：使用诊断脚本
```bash
cd server
python 语音转写敏感度诊断脚本.py
```

### 第二步：应用环境变量优化
```bash
# 创建配置文件
cat > .env << EOF
LIVE_VAD_MIN_RMS=0.012
LIVE_VAD_MIN_SPEECH_SEC=0.25
LIVE_VAD_MIN_SILENCE_SEC=0.45
LIVE_AUDIO_PROFILE=fast
LIVE_AUDIO_AGC_TARGET=0.1
EOF

# 重启服务
```

### 第三步：测试验证
1. 测试轻声说话场景
2. 测试背景音乐环境
3. 测试快速对话场景
4. 监控误检率和漏检率

### 第四步：精细调优
根据测试结果进一步调整参数，直到达到最佳平衡点。

## 监控指标

### 关键指标
- **检测率**: 真实语音被正确识别的比例
- **误检率**: 非语音被错误识别为语音的比例
- **响应延迟**: 从语音开始到识别结果的时间
- **置信度分布**: 识别结果的置信度统计

### 监控方法
```python
# 在服务中添加统计
class VADStats:
    def __init__(self):
        self.total_chunks = 0
        self.speech_detected = 0
        self.avg_confidence = 0.0
        self.response_times = []
    
    def update(self, is_speech, confidence, response_time):
        self.total_chunks += 1
        if is_speech:
            self.speech_detected += 1
        self.avg_confidence = (self.avg_confidence * (self.total_chunks - 1) + confidence) / self.total_chunks
        self.response_times.append(response_time)
```

## 预期效果

通过以上优化，预期能够：

1. **提高敏感度一致性**: 减少"有时灵敏有时不灵敏"的问题
2. **降低漏检率**: 更好地捕获轻声说话和短语音
3. **保持低误检率**: 避免过度敏感导致的噪音误触发
4. **提高响应速度**: 减少语音识别的延迟
5. **适应不同环境**: 在各种噪音环境下都能稳定工作

## 注意事项

1. **参数调整需要渐进式**: 不要一次性大幅调整多个参数
2. **需要充分测试**: 在不同环境和场景下验证效果
3. **监控副作用**: 注意调整后是否引入新的问题
4. **保留回退方案**: 记录原始配置，以便必要时回退

## 总结

语音转写敏感度不一致主要是由于VAD参数配置过于保守导致的。通过降低RMS阈值、减少最小语音时间、调整置信度要求等方式，可以显著改善语音识别的一致性和敏感度。建议先通过环境变量进行快速调优，然后根据实际效果进行精细化调整。