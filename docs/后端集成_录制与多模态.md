# 后端集成方案：抖音直播录制 + 5 分钟多模态分析 + SenseVoice 转写

本文档说明如何在现有后端（FastAPI）中集成「仅后端」的直播录制与多模态智能话术分析能力：
- 复用 StreamCap 的平台解析与录制能力（不引入其 Flet 前端），实现抖音直播 5 分钟分段录制（含音轨）。
- 同步聚合该时间窗内的直播弹幕文本。
- 使用阿里云 Qwen3 多模态模型，对视频/图文 + 文本做融合分析，生成 3–5 条“智能提示话术”。
- 可选：用 SenseVoice（本地）对主播口播做转写/摘要，增强文本语义输入。

---

## 1. 背景与目标
- 目标：在不改动现有前端的前提下，面向后端添加“录制→分段→聚合→多模态分析→产出 AIScript”的流水线。
- 范围：抖音优先；多平台扩展由 `streamget` 适配器自动兼容。
- 输出：结构化话术（`AIScript`），用于驱动主播的实时/准实时提示。

## 2. 总体方案与数据流
组件（后端）：
- RecorderService：解析直播 URL → 选择 FLV/HLS → 以 ffmpeg 启动分段录制（每 300s 一段）。
- SegmentIndex：记录每个分段文件的路径、序号与时间窗（start_ts~end_ts）。
- CommentStore：订阅抖音 SSE（已有 `server/app/api/douyin_web.py`），按房间与时间写入存储；提供按时间窗的查询。
- SegmentAnalyzer（Qwen）：接收 `segment_ready` 事件，抽取关键帧（或直传视频）+ 拼接该窗的弹幕文本 +（可选）口播摘要，调用 Qwen 多模态生成话术 → 落地 `AIScript`。
- 可选 ASR：`AST_module`（SenseVoice）生成音频文本，提高模型对语义的捕获稳定性。

数据流：
1) Start Recording → 解析 record_url → ffmpeg 分段录制（5 分钟/段）。
2) 每段落地 → 触发 `segment_ready` → 写入 `SegmentIndex` 并排队分析。
3) 分析器取该段时间窗内弹幕；抽帧（或传视频）→ 调用 Qwen 多模态 → 产出 3–5 条话术。
4) 结果保存为 `AIScript`，对外提供 REST（`/api/analysis/tips/latest`）。

## 3. 依赖与安装
- Python 依赖（建议加入 `server/requirements.txt`）
  - `streamget>=4.0.8` （直播平台解析：抖音/快手/虎牙/斗鱼…）
  - `dashscope` （阿里云多模态 SDK）
  - `aiofiles`（如需异步 I/O）
- 系统依赖
  - `ffmpeg`（必须可执行；Windows/Mac/Linux 按平台安装）
- 环境变量（`.env`）
  - `DASHSCOPE_API_KEY=你的阿里云DashScope Key`
  - `QWEN_MM_MODEL=qwen-vl-max`（或其他可用多模态型号）
  - `RECORDS_ROOT=/data/records`（默认可落项目内 `records/`）
  - 可选：`DOUYIN_COOKIE=...`、`HTTP_PROXY=...`

## 4. 录制实现（5 分钟分段）
1) 解析直播流（复用 StreamCap/streamget）
```python
from server.modules.streamcap.platforms import get_platform_handler

handler = get_platform_handler(live_url, proxy=os.getenv('HTTP_PROXY'), cookies=os.getenv('DOUYIN_COOKIE'))
info = await handler.get_stream_info(live_url)  # 返回包含 flv_url/m3u8_url/record_url/anchor_name/title 等
```
2) 选择录制源（优先 FLV 实时，H265 则改 HLS/TS）
```python
record_url = info.flv_url or info.record_url
```
3) ffmpeg 分段录制（300s/段，直接拷贝编码）
```bash
ffmpeg -y -headers "referer:https://live.douyin.com" -i "<record_url>" \
  -c copy -movflags +faststart \
  -f segment -segment_time 300 -reset_timestamps 1 \
  "/data/records/douyin/{anchor}/{YYYY-mm-dd}/{anchor}_%Y%m%d_%H%M%S_%03d.mp4"
```
4) 命名与目录结构
```
/data/records/{platform}/{anchor}/{YYYY-mm-dd}/{anchor}_{YYYYmmdd_HHMMSS}_%03d.mp4
```
5) 进程管理
- `asyncio.create_subprocess_exec` 启动；Windows 以 `stdin 'q'` 优雅停止，非 Windows 用 `SIGINT`。
- 每个新片段生成时，判断“文件大小稳定”作为 `segment_ready` 的触发条件。

## 5. 分段索引与事件
- SQLite 表（或 JSON 初版）：`segment_index`
  - `recording_id` TEXT、`seq` INT、`path` TEXT、`start_ts` INT、`end_ts` INT、`room_id` TEXT、`anchor_name` TEXT、`platform_key` TEXT、`created_at` INT
- SSE 通道：`GET /api/recording/events`
  - 事件：`{"type":"segment_ready","data":{"recording_id":"...","seq":12,"path":"...","start_ts":...,"end_ts":...}}`

## 6. 弹幕聚合
- 复用 `server/app/api/douyin_web.py` 中继（SSE）。
- 写入表 `comments`：`id,user,content,ts,room_id,platform,metadata`。
- 提供查询：`get_comments_between(room_id, start_ts, end_ts, limit=...)`。

## 7. SenseVoice 转写（可选增强）
- 模式 A（推荐）：直播直抓 → 直接调用 `/api/live_audio/start`；无需设备选择与本地回环。
- 模式 B：直播流解码为 PCM（将 record_url 通过 ffmpeg 解码为 16k/单声道，喂给 AST 流）
- 模式 C：离线对 5 分钟分段转写，生成“口播摘要”拼入多模态文本。
- 已有 fast 预设（`chunk_duration=0.4s`、`assembler.max_wait=2.0` 等）可直接复用。

## 8. Qwen3 多模态分析
- 默认方案：抽帧 + 弹幕文本（成本/时延更优）。必要时支持“视频直传”。
- 抽帧建议：每 10s 抽 1 帧，最多 24 帧；限制分辨率 ≤480p；分析后清理中间文件。
- 提示词（要点）
  - 角色：资深带货话术教练；结合画面/弹幕/口播摘要产出 3–5 条“可执行、自然、含CTA”的话术。
  - 约束：不夸大承诺；回答高频问题（价格/尺码/发货）给出可模板化应答。
- 调用示例（多图+文本）：
```python
from http import HTTPStatus
from dashscope import MultiModalConversation

def call_qwen_multimodal(images:list[str], comments:str, system_tip:str):
    messages = [
      {"role": "system", "content": [{"text": system_tip}]},
      {"role": "user",   "content": ([{"image_url": p} for p in images] + [{"text": comments}])}
    ]
    rsp = MultiModalConversation.call(
        model=os.getenv("QWEN_MM_MODEL","qwen-vl-max"),
        messages=messages,
        api_key=os.environ["DASHSCOPE_API_KEY"],
    )
    if rsp.status_code != HTTPStatus.OK:
        raise RuntimeError(f"Qwen error: {rsp.code} {rsp.message}")
    return rsp.output_text  # 建议输出 JSON，解析为 AIScript 列表
```
- 输出 JSON Schema（建议）
```json
[
  {"text":"话术内容","type":"welcome|product|interaction|closing","tags":["douyin","segment-5m"],"score":0.0}
]
```

## 9. API 设计（新增）
- 录制控制
  - `POST /api/recording/start`
    - body：`{"live_url":"https://live.douyin.com/...","segment_time":300,"quality":"OD","save_format":"mp4"}`
    - resp：`{"recording_id":"...","output":"/data/records/douyin/..."}`
  - `POST /api/recording/stop`（按 recording_id 停止）
  - `GET /api/recording/status?recording_id=...`
  - `GET /api/recording/events`（SSE：推送 `segment_ready`）
- 分析控制
  - `POST /api/analysis/segment`（可选：手动触发分析）
  - `GET /api/analysis/tips/latest?limit=5`（返回 `AIScript[]`）

## 10. 安全与配置
- 鉴权：SSE/REST 统一 Bearer；限制受信 Origin（CORS）。
- 频控与重试：每个分段仅触发一次多模态；失败指数退避 ≤3 次。
- 资源：控制录制并发数；磁盘空间阈值不足时暂停录制并告警。
- 日志脱敏：不打印 API Key/Cookie；敏感参数入库时加密/掩码。

## 11. 快速开始（本地）
1) 安装依赖：
```bash
pip install -r requirements.all.txt  # 统一安装（含 streamget/dashscope）
# 安装 ffmpeg 后，启动 FastAPI：
uvicorn server.app.main:app --reload --port 10090
```
2) 启动 Douyin 中继（已有）：
- 打开 `/static/douyin_test.html`，填入 live_id，点击 Start。
3) 启动录制：
```bash
curl -X POST http://127.0.0.1:10090/api/recording/start \
  -H 'Content-Type: application/json' \
  -d '{"live_url":"https://live.douyin.com/XXXXXXXX","segment_time":300}'
```
4) 订阅分段事件：
```bash
curl -N http://127.0.0.1:10090/api/recording/events
```
5) 查看结果：
- 录制目录是否每 5 分钟生成一个文件；
- `GET /api/analysis/tips/latest?limit=5` 是否返回话术列表。

## 12. 验收清单（Checklist）
- [ ] 分段文件按 300s 落地，命名与目录结构正确。
- [ ] SSE 能收到 `segment_ready`，含正确的 start/end 时间窗。
- [ ] 在时间窗内能查询到对应弹幕集合。
- [ ] Qwen 多模态成功返回，生成 3–5 条话术，落地为 `AIScript`。
- [ ] 磁盘阈值触发时暂停录制并恢复正常提示。
- [ ] API 鉴权与 CORS 生效，无敏感日志外泄。

## 13. 后续里程碑
- P0：录制落地 + 分段事件（1–2 天）。
- P1：弹幕聚合 + 分段索引（1 天）。
- P2：多模态分析骨架（抽帧 + Qwen 调用）（1–2 天）。
- P3：ASR 口播摘要（可选）、指标与监控、完善测试（1–2 天）。

---

## 附：参考实现的文件建议
- `server/app/services/recorder_service.py`：录制控制（start/stop/status）与分段检测。
- `server/app/api/recording.py`：录制相关路由。
- `server/app/api/recording_events.py`：SSE 推送 `segment_ready`。
- `server/analysis/segment_index.py`：分段索引与 SQLite 存取。
- `server/analysis/frame_extractor.py`：抽帧工具。
- `server/analysis/segment_analyzer.py`：窗口弹幕聚合 + Qwen 调用 + `AIScript` 落地。
- `server/ai/qwen_multimodal.py`：DashScope 客户端封装。

落地后，请在 `server/app/main.py` 挂载上述新路由，并在 `docs/DEPLOYMENT.md` 增补 ffmpeg 与 DashScope 配置说明。
