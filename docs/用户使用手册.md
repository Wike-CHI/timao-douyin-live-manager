# 提猫直播助手 · 用户使用手册（MVP）

> 版本：v1.0（2025-09-26）  适用产品：TalkingCat 桌面端（Electron）+ 本地 FastAPI 服务

本手册面向主播与运营同学，介绍提猫直播助手的安装、启动与功能使用（实时字幕、弹幕互动、AI 分析、录制复盘等），并提供常见问题排查与开发者接口说明。

---

## 1. 系统要求与准备

- 操作系统：Windows 10/11、macOS 10.15+、Ubuntu 20.04+
- 运行环境：
  - Node.js ≥ 16，npm ≥ 8
  - Python ≥ 3.8
  - ffmpeg（命令行可用）
- 存储与网络：首次模型下载需要 1~2 GB 空间与网络访问

可选（启用 AI 分析窗口/整场复盘）：
- OpenAI 兼容接口（如 DashScope）：`OPENAI_BASE_URL`、`OPENAI_API_KEY`、`OPENAI_MODEL`

> 提示：仓库内置了开发用的 DashScope 兼容配置，仅用于本地验证。生产请改为自己的 Key 与 Base URL。

---

## 2. 安装与启动

1) 克隆与依赖安装（根目录执行）

```bash
pip install -r requirements.all.txt
npm ci
```

2) 预下载识别模型（推荐提前执行，避免直播时首次加载卡顿）

```bash
# 需要网络与 modelscope
pip install -U modelscope
python tools/download_sensevoice.py
python tools/download_vad_model.py
```

3) 启动（Electron 将自启 FastAPI: 127.0.0.1:8007）

```bash
npm run dev
```

4) 可选：手动分别启动

```bash
# 前端（开发服务器 30013）
(cd electron/renderer && npm run dev)
# 后端（FastAPI 8007）
uvicorn server.app.main:app --reload --host 127.0.0.1 --port 8007
# Electron 主窗体（等待 30013 就绪）
(cd electron && npm start)
```

访问：
- 桌面端窗口将自动打开；浏览器可访问 http://127.0.0.1:30013
- 后端 API 文档：http://127.0.0.1:8007/docs
- 静态测试页：http://127.0.0.1:8007/static/douyin_test.html、/static/live_test.html

环境变量（可选）：
- 根目录 `.env` 中设置 `ELECTRON_START_API=true|false` 控制 Electron 是否自启后端
- `electron/renderer/.env` 可设置 `VITE_FASTAPI_URL=http://127.0.0.1:8007`
- AI 接口：`OPENAI_BASE_URL`、`OPENAI_API_KEY`、`OPENAI_MODEL`

---

## 3. 功能总览

- 直播互动：实时同步抖音直播间弹幕、礼物、点赞（SSE）
- 本地语音转写：SenseVoice 小型模型 + VAD 稳定整句（WebSocket）
- AI 实时分析：按滚动窗口输出亮点、风险、建议、可用话术（SSE）
- 录制复盘：ffmpeg 分段录制 → 离线转写 → 复盘报告（HTML）
- 热词管理：品牌/人名/地名等统一替换，优化转写文本
- 持久化开关：可将转写与弹幕以 JSONL 实时落盘

---

## 4. 界面操作指南

进入主界面（登录与“钱包”默认走本地模拟）：
- 「直播控制台」：实时字幕、互动流与 AI 分析的总控台
- 「工具箱」：模型预下载、热词管理
- 「直播报告」：占位页（复盘在控制台内启动）

4.1 直播直抓（实时字幕 + 互动）
- 在“直播地址或ID”输入框粘贴 `https://live.douyin.com/<直播ID>` 或直接填直播 ID
- 点击“开始转写”：
  - 弹幕抓取会通过 `/api/douyin/web/start` 启动，前端自动连到 `/api/douyin/web/stream`
  - 音频拉流→转写通过 `/api/live_audio/start`，前端自动连到 `/api/live_audio/ws`
- 面板显示：实时字幕、弹幕/礼物、互动事件、平均置信度、输入电平等
- 点击“停止”同时关闭两路流

4.2 AI 实时分析（滚动窗口）
- 需先开始转写；默认 60 秒窗口，可在右上角输入框调整（30~600 秒）
- 事件源：`/api/ai/live/stream`；内容含 summary/risks/suggestions/scripts 等
- 如需云端模型，请配置 `OPENAI_BASE_URL`/`OPENAI_API_KEY`/`OPENAI_MODEL`

4.3 录制复盘（离线）
- 控制台右侧“录制复盘”卡片：
  - “开始录制”：`/api/report/live/start`（默认 30 分钟分段；UI演示 5 分钟）
  - “停止录制”：`/api/report/live/stop`
  - “生成报告”：`/api/report/live/generate`
- 产物（示例路径）：
  - 片段视频：`records/douyin/<主播>/<YYYY-MM-DD>/<session_id>/*.mp4`
  - 互动弹幕：`.../artifacts/comments.jsonl`
  - 整场转写：`.../artifacts/transcript.txt`
  - 复盘报告：`.../artifacts/report.html`

4.4 热词管理与模型缓存（工具箱）
- 预下载模型：点击“预下载·轻量（Small）”，状态面板会显示缓存路径与大小
- 热词管理：
  - 结构示例：
    ```json
    {
      "replace": {
        "星巴克": ["星八克", "星巴客"],
        "索尼": ["SONY", "so-ny"]
      }
    }
    ```
  - 保存后立即生效；文件位置：`data/hotwords.json`
  - 可“恢复默认”（若存在 `data/hotwords.default.json`）

4.5 数据持久化（实时日志）
- 控制台「持久化」开关可分别记录：语音转写、弹幕流
- 默认根目录：`records/live_logs`；按 `live_id/YYYY-MM-DD/` 归档，文件为 JSONL 流

---

## 5. 常见问题排查（FAQ）

- 启动失败/白屏：确认依赖安装完成；查看终端/Electron DevTools 日志
- 8007/30013 端口占用：修改 Electron 或渲染端端口，使之与 `VITE_FASTAPI_URL` 一致
- ffmpeg 未找到：安装 ffmpeg 并确保命令行可用（Windows 需加入 PATH）
- 首次转写卡顿：提前在工具箱“预下载模型”，或按 2) 的脚本下载
- 抖音互动无消息：
  - 直播间已关闭/水平防护：更换直播或稍后再试
  - 个别房间需登录 Cookie：后端 `/api/douyin/start` 支持 `cookie` 字符串
- AI 分析无结果：
  - 未配置可用的 OpenAI 兼容接口；或网络不可达
  - 等待 1~2 个窗口后再看（需要积累窗口数据）
- 转写与整句不稳定：使用默认“稳妥（VAD）”模式；必要时在 `/api/live_audio/start` 里微调 `vad_*` 与 `max_*` 参数

---

## 6. 开发者接口速览（选读）

- 直播音频（ASR）`/api/live_audio`
  - `POST /start` { live_url, chunk_duration?, vad_*?, max_*? }
  - `POST /stop`
  - `GET /status` | `GET /health`
  - `POST /advanced` { music_filter?, diarization?, max_speakers?, persist_*? }
  - `POST /preload_models` { sizes: ["small"] } | `GET /models`
  - `WS /ws` 消息：`transcription_delta`/`transcription`/`level`

- 抖音互动（Web 抓取桥）`/api/douyin/web`
  - `POST /start` { live_id | live_url }
  - `POST /stop` | `GET /status`
  - `GET /stream`（SSE，事件：chat/gift/like/member/...）
  - `POST /persist` { persist_enabled?, persist_root? }

- 录制复盘 `/api/report/live`
  - `POST /start` { live_url, segment_minutes? } | `POST /stop`
  - `POST /generate` → { comments, transcript, report }

- AI 实时分析 `/api/ai/live`
  - `POST /start` { window_sec } | `POST /stop` | `GET /status`
  - `GET /stream`（SSE）

- 热词管理 `
  - `GET /api/nlp/hotwords` | `POST /api/nlp/hotwords` { replace }
  - `POST /api/nlp/hotwords/reset`

测试与样例：
- 静态测试页：`/static/douyin_test.html`、`/static/live_test.html`
- cURL 示例：
  ```bash
  curl -X POST http://127.0.0.1:8007/api/douyin/web/start -H 'Content-Type: application/json' -d '{"live_url":"https://live.douyin.com/xxxx"}'
  curl -X POST http://127.0.0.1:8007/api/live_audio/start -H 'Content-Type: application/json' -d '{"live_url":"https://live.douyin.com/xxxx"}'
  ```

---

## 7. 数据与目录约定

- 模型缓存：`models/.cache`（ModelScope）与 `models/models/iic/*`
- 实时日志：`records/live_logs/<live_id>/<YYYY-MM-DD>/`
- 复盘会话：`records/douyin/<主播>/<YYYY-MM-DD>/<session_id>/`
  - `*.mp4` 分段、`artifacts/` 下存放 `comments.jsonl` / `transcript.txt` / `report.html`

---

## 8. 免责声明与建议

- 请遵守平台协议与当地法律，仅在获得授权的直播间采集公开数据
- 语音/弹幕分析存在容错与召回限制，请在重要场景下人工复核
- 建议正式直播前进行一次完整演练（含模型预下载与网络巡检）

---

如需二次开发或二次封装，请参阅：
- README.md（快速开始与项目结构）
- docs/启动说明.md（端口与分进程启动）
- /server/app/main.py（路由装配）与 /server/app/api/*（路由实现）
