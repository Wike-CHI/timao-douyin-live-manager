# F2集成需求对齐文档 - 抖音直播数据抓取

## 📋 项目概述

### 目标
将F2项目集成到提猫直播助手中，实现抖音直播间数据的实时抓取和处理功能。

### 现有项目分析

#### 提猫直播助手架构
- **技术栈**: Python Flask + Electron
- **核心功能**: 评论管理、热词分析、AI话术生成、配置管理
- **数据存储**: SQLite数据库
- **前端**: Electron + HTML/CSS/JavaScript
- **API架构**: RESTful API + SSE流式接口

#### F2项目能力评估
- **核心优势**: 
  - 成熟的抖音数据抓取框架
  - 支持多种数据类型（用户信息、作品、评论、直播等）
  - 完整的WebSocket直播弹幕抓取
  - 反爬虫算法支持（XBogus/ABogus）
  - 异步处理架构

- **关键模块**:
  - `DouyinCrawler`: HTTP API数据抓取
  - `DouyinWebSocketCrawler`: 直播弹幕实时抓取
  - `DouyinHandler`: 数据处理和业务逻辑
  - 算法模块: 签名生成和反爬虫

## 🎯 需求规范

### 功能需求

#### 1. 直播间数据抓取
- **直播状态监控**: 实时检测主播开播/关播状态
- **弹幕数据抓取**: 实时获取直播间评论、点赞、礼物等互动数据
- **用户信息获取**: 抓取评论用户的基本信息（昵称、头像等）
- **直播间统计**: 观看人数、点赞数等实时数据

#### 2. 数据处理与存储
- **数据清洗**: 过滤无效评论、去重处理
- **格式标准化**: 统一数据格式，适配现有数据库结构
- **实时推送**: 通过SSE接口推送新数据到前端
- **历史数据**: 支持历史评论数据的查询和分析

#### 3. 配置管理
- **抖音账号配置**: Cookie管理、用户认证
- **抓取参数配置**: 抓取频率、数据类型选择
- **代理设置**: 支持HTTP代理配置

### 非功能需求

#### 1. 性能要求
- **实时性**: 弹幕延迟 < 2秒
- **并发处理**: 支持多个直播间同时监控
- **资源占用**: 内存使用 < 500MB，CPU使用率 < 30%

#### 2. 稳定性要求
- **异常处理**: 网络异常自动重连
- **数据完整性**: 确保关键数据不丢失
- **容错机制**: 单个直播间异常不影响其他直播间

#### 3. 安全要求
- **Cookie安全**: 敏感信息加密存储
- **反爬虫应对**: 使用F2的算法模块规避检测
- **访问频率控制**: 避免过于频繁的请求

## 🔍 技术约束

### 集成约束
1. **架构兼容**: 必须与现有Flask架构兼容
2. **数据库兼容**: 复用现有SQLite数据库结构
3. **API兼容**: 保持现有API接口不变，仅扩展功能
4. **依赖管理**: 最小化新增依赖，避免版本冲突

### 技术限制
1. **Python版本**: 需要Python 3.10+（F2要求）
2. **异步处理**: 需要集成asyncio到Flask应用
3. **WebSocket支持**: 需要支持WSS连接到抖音服务器
4. **算法依赖**: 需要集成F2的反爬虫算法

## 📊 数据模型

### 直播间信息
```python
{
    "room_id": "直播间ID",
    "web_rid": "Web直播间ID", 
    "title": "直播间标题",
    "status": "直播状态(2:直播中, 4:已关播)",
    "user_count": "观看人数",
    "like_count": "点赞数",
    "owner": {
        "sec_uid": "主播ID",
        "nickname": "主播昵称",
        "avatar": "头像URL"
    }
}
```

### 弹幕数据
```python
{
    "msg_id": "消息ID",
    "content": "弹幕内容",
    "user": {
        "sec_uid": "用户ID",
        "nickname": "用户昵称", 
        "avatar": "头像URL",
        "level": "用户等级"
    },
    "timestamp": "时间戳",
    "msg_type": "消息类型(chat/like/gift/member)"
}
```

## ❓ 待澄清问题

### 关键决策点
1. **直播间识别方式**: 
   - 通过直播间URL？
   - 通过主播用户名？
   - 支持批量监控吗？

2. **数据存储策略**:
   - 是否需要持久化所有弹幕数据？
   - 数据保留周期是多长？
   - 是否需要数据导出功能？

3. **实时性要求**:
   - 弹幕延迟容忍度是多少？
   - 是否需要离线模式支持？

4. **用户界面集成**:
   - 需要在现有界面中添加哪些功能？
   - 是否需要独立的直播监控页面？

### 技术疑问
1. **Cookie获取方式**: 用户如何提供抖音Cookie？
2. **多直播间支持**: 最多同时监控几个直播间？
3. **错误处理**: 当抖音更新反爬虫策略时如何应对？

## 🎯 验收标准

### 功能验收
- [ ] 能够成功连接到指定抖音直播间
- [ ] 实时接收并解析弹幕数据
- [ ] 数据正确存储到数据库
- [ ] 通过API接口正确返回数据
- [ ] 前端能够实时显示新弹幕

### 性能验收
- [ ] 弹幕延迟 < 2秒
- [ ] 系统运行稳定，无内存泄漏
- [ ] 支持至少3个直播间同时监控
- [ ] 异常情况下能够自动恢复

### 兼容性验收
- [ ] 不影响现有功能正常运行
- [ ] 新增API接口符合现有规范
- [ ] 配置管理集成到现有系统

## 📝 下一步行动

1. **澄清关键决策点** - 等待用户确认上述问题
2. **创建技术架构设计** - 基于确认的需求设计集成方案
3. **制定详细实施计划** - 拆分具体开发任务
4. **开始原型开发** - 实现核心功能验证

---

*文档版本: v1.0*  
*创建时间: 2025-01-21*  
*状态: 待用户确认*